<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>CH559 Programming (Part 4): Using UART - Kali Prasad</title><meta name=Description content="CH559 Programming (Part 4): Using UART - Kali Prasad"><link rel=icon type=image/png href=/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="CH559 Programming (Part 4): Using UART"><meta property="og:description" content="Bare Metal programming with CH559"><meta property="og:type" content="article"><meta property="og:url" content="https://kprasadvnsi.com/posts/bare-metal-ch559-pt4/"><meta property="og:image" content="https://kprasadvnsi.com/ch559_uart_demo.png"><meta property="article:published_time" content="2020-03-31T00:00:00+00:00"><meta property="article:modified_time" content="2020-03-31T00:00:00+00:00"><meta property="og:site_name" content="Kali Prasad"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kprasadvnsi.com/ch559_uart_demo.png"><meta name=twitter:title content="CH559 Programming (Part 4): Using UART"><meta name=twitter:description content="Bare Metal programming with CH559"><meta name=twitter:site content="@kprasadvnsi"><meta name=twitter:creator content="@kprasadvnsi"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"CH559 Programming (Part 4): Using UART","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/kprasadvnsi.com\/posts\/bare-metal-ch559-pt4\/"},"image":{"@type":"ImageObject","url":"https:\/\/kprasadvnsi.com\/ch559_uart_demo.png","width":696,"height":383},"genre":"posts","keywords":"Bare Metal, CH559, 8051, MCS-51, UART","wordcount":663,"url":"https:\/\/kprasadvnsi.com\/posts\/bare-metal-ch559-pt4\/","datePublished":"2020-03-31T00:00:00","dateModified":"2020-03-31T00:00:00","license":"© 2020 Kali Prasad","publisher":{"@type":"Organization","name":"Kali Prasad","logo":{"@type":"ImageObject","url":"https:\/\/kprasadvnsi.com\/avatar.png","width":80,"height":80}},"author":{"@type":"Person","name":"Kali Prasad"},"description":"Bare Metal programming with CH559"}</script><link rel=preload href=https://kprasadvnsi.com/css/bundle.min.7ceb6505cb87d0614f44be28b935ac372beb44497009528d82e25ed4360ef407.css as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet type=text/css media=screen href=https://kprasadvnsi.com/css/bundle.min.7ceb6505cb87d0614f44be28b935ac372beb44497009528d82e25ed4360ef407.css></noscript><script data-ad-client=ca-pub-6490269775913302 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(function(w){"use strict";if(!w.loadCSS){w.loadCSS=function(){};}
var rp=loadCSS.relpreload={};rp.support=(function(){var ret;try{ret=w.document.createElement("link").relList.supports("preload");}catch(e){ret=false;}
return function(){return ret;};})();rp.bindMediaToggle=function(link){var finalMedia=link.media||"all";function enableStylesheet(){if(link.addEventListener){link.removeEventListener("load",enableStylesheet);}else if(link.attachEvent){link.detachEvent("onload",enableStylesheet);}
link.setAttribute("onload",null);link.media=finalMedia;}
if(link.addEventListener){link.addEventListener("load",enableStylesheet);}else if(link.attachEvent){link.attachEvent("onload",enableStylesheet);}
setTimeout(function(){link.rel="stylesheet";link.media="only x";});setTimeout(enableStylesheet,3000);};rp.poly=function(){if(rp.support()){return;}
var links=w.document.getElementsByTagName("link");for(var i=0;i<links.length;i++){var link=links[i];if(link.rel==="preload"&&link.getAttribute("as")==="style"&&!link.getAttribute("data-loadcss")){link.setAttribute("data-loadcss",true);rp.bindMediaToggle(link);}}};if(!rp.support()){rp.poly();var run=w.setInterval(rp.poly,500);if(w.addEventListener){w.addEventListener("load",function(){rp.poly();w.clearInterval(run);});}else if(w.attachEvent){w.attachEvent("onload",function(){rp.poly();w.clearInterval(run);});}}
if(typeof exports!=="undefined"){exports.loadCSS=loadCSS;}
else{w.loadCSS=loadCSS;}}(typeof global!=="undefined"?global:this));</script></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=https://kprasadvnsi.com/><picture>
<source type=image/webp srcset=/avatar.webp><img src=/avatar.png alt="Kali Prasad"></picture></a></div><p class=site-title><a href=https://kprasadvnsi.com/>Kali Prasad</a></p><div class=site-description><p>Random blog</p><nav class="nav social"><ul class=flat><li class=li-social><a href=https://twitter.com/kprasadvnsi><i title=Twitter class="icons fab fa-twitter"></i></a></li><li class=li-social><a href=https://mastodon.social/@kprasadvnsi><i title=Mastodon class="icons fab fa-mastodon"></i></a></li><li class=li-social><a href=https://t.me/kprasadvnsi><i title=Telegram class="icons fab fa-telegram"></i></a></li><li class=li-social><a href=https://github.com/kprasadvnsi><i title=Github class="icons fab fa-github"></i></a></li><li class=li-social><a href=https://www.youtube.com/channel/UCJYk1lszl4uCf-kcCu27Ogw><i title=Youtube class="icons fab fa-youtube"></i></a></li><li class=li-social><a href=mailto:kprasadvnsi@protonmail.com><i title=Email class="icons fas fa-at"></i></a></li><li class=li-social><a href=/index.xml><i title=RSS class="icons fas fa-rss"></i></a></li></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/about>About</a></li><li><a href=/tags>Tags</a></li></ul></nav></div><div class=post><div class=author></div><div class=post-header><div class=meta><div class=date><span class=day>31</span>
<span class=rest>Mar 2020</span></div></div><div class=matter><h1 class=title>CH559 Programming (Part 4): Using UART</h1></div></div><div class=markdown><p><img src=/ch559_uart_demo.png alt="CH559 UART0 Demo"></p><p>After toggling some I/O pins, the first thing you should get up and running on a new platform is UART. CH559 chip provides two full-duplex asynchronous serial ports: UART0 and UART1. UART0 is a standard MCS51 serial port, and UART1 is an enhanced asynchronous serial port with a lot of features that we talk about in future tutorials.</p><p>We need the datasheet for register definitions. WCH only provides Datasheet in Chinese. I have translated the datasheet, you can find it <a href=https://kprasadvnsi.github.io/CH559_Doc_English/>here</a>. Complete source code is also available on this <a href=https://github.com/kprasadvnsi/ch55x_bare_metal>GitHub Repo</a>.</p><h2 id=uart0-initialization>UART0 Initialization</h2><p>First, we need to select the UART mode by setting SM0 and SM1 bit in the SCON register. We are going to use Mode 1 for UART0.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#888>// SM0 &amp; SM1: UART0 mode
</span><span style=color:#888>// 00 - mode 0, shift Register, baud rate fixed at: Fsys/12
</span><span style=color:#888>// 01 - mode 1, 8-bit UART,     baud rate = variable by timer1 or timer2 overflow rate
</span><span style=color:#888>// 10 - mode 2, 9-bit UART,     baud rate fixed at: Fsys/128@SMOD=0, Fsys/32@SMOD=1
</span><span style=color:#888>// 11 - mode 3, 9-bit UART,     baud rate = variable by timer1 or timer2 overflow rate
</span><span style=color:#888></span>SM0 <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>0</span>;
SM1 <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>;</code></pre></td></tr></table></div></div><p>Next, we need to select a clock source from either timer1 or timer2. We will choose timer1 as our clock source for UART0 by setting RCLK and TCLK bits in the T2CON register.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#888>// RCLK select UART0 receiving clock: 0=timer1 overflow pulse, 1=timer2 overflow pulse
</span><span style=color:#888>// TCLK select UART0 transmittal clock: 0=timer1 overflow pulse, 1=timer2 overflow pulse
</span><span style=color:#888></span>RCLK <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>0</span>;
TCLK <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>0</span>;</code></pre></td></tr></table></div></div><p>We configure timer1 with 12MHz internal clock in mode 2 for baud rate 9600 by setting bT1_M1 and bT1_M0 bits in the TMOD register.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#888>// bT1_M1 &amp; bT1_M0: timer1 mode
</span><span style=color:#888>// 00: mode 0, 13-bit timer or counter by cascaded TH1 and lower 5 bits of TL1, the upper 3 bits of TL1 are ignored
</span><span style=color:#888>// 01: mode 1, 16-bit timer or counter by cascaded TH1 and TL1
</span><span style=color:#888>// 10: mode 2, TL1 operates as 8-bit timer or counter, and TH1 provide initial value for TL1 auto-reload
</span><span style=color:#888>// 11: mode 3, stop timer1
</span><span style=color:#888></span>
TMOD <span style=color:#333>=</span> MASK_T1_MOD <span style=color:#333>&amp;</span> (bT1_M1 <span style=color:#333>|</span> <span style=color:#333>~</span>bT1_M0);</code></pre></td></tr></table></div></div><p>CH559 provide different speed mode for UART0 baud rate generation for power saving purpose. We are going to use fast Mode by setting a SMOD bit in the PCON register. We also need to set bTMR_CLK and bT1_CLK in the T2MOD register to get a 12MHz clock.</p><p>CH559 provides several ways to generate the baud rate. The baud rate generation formula for different UART0, speeds are listed in the table below.</p><p><img src=/uart0_baud_farmula_table.png alt="Calculation formula of UART0 baud rate generated by T1"></p><p>We will choose the 2nd option in the list above and set TH1 register for 9600 baud rate.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>PCON <span style=color:#333>|=</span> SMOD;
T2MOD <span style=color:#333>=</span> T2MOD <span style=color:#333>|</span> bTMR_CLK <span style=color:#333>|</span> bT1_CLK;
TH1 <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>256</span> <span style=color:#333>-</span> FREQ_SYS<span style=color:#333>/</span><span style=color:#00d;font-weight:700>16</span><span style=color:#333>/</span>UART0_BAUD;</code></pre></td></tr></table></div></div><p>Now, we will start the timer1 by setting the TR1 bit. Set the transmit interrupt flag TI for UART0. and enable the UART0 by setting REN bit in the SCON register.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>TR1 <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>;
TI <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>;
REN <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>1</span>;</code></pre></td></tr></table></div></div><h2 id=sending-data-to-uart0>Sending Data to UART0</h2><p>We can send data via UART0 by writing on the SBUF register.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#888>// Send one byte data to UART0
</span><span style=color:#888></span><span style=color:#339;font-weight:700>void</span> <span style=color:#06b;font-weight:700>uart0_write</span>(uint8_t data) {
    <span style=color:#080;font-weight:700>while</span> (<span style=color:#333>!</span>TI);
    TI <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>0</span>;
    SBUF <span style=color:#333>=</span> data <span style=color:#333>&amp;</span> <span style=color:#058;font-weight:700>0xFF</span>;
}</code></pre></td></tr></table></div></div><h2 id=receiving-data-from-uart0>Receiving Data from UART0</h2><p>We can receive data from UART0 by reading the SBUF register.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#888>// Receive one byte data from UART0
</span><span style=color:#888></span>uint8_t <span style=color:#06b;font-weight:700>uart0_read</span>() {
    <span style=color:#080;font-weight:700>while</span>(<span style=color:#333>!</span>RI);
    RI <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>0</span>;
    <span style=color:#080;font-weight:700>return</span> SBUF;
}</code></pre></td></tr></table></div></div><h2 id=using-printf-with-uart0>Using printf with UART0</h2><p>Redirecting stdout is easy with SDCC</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#888>/*
</span><span style=color:#888> * Redirect stdout to UART0
</span><span style=color:#888> */</span>
<span style=color:#339;font-weight:700>int</span> <span style=color:#06b;font-weight:700>putchar</span>(<span style=color:#339;font-weight:700>int</span> c) {
    uart0_write(c);
    <span style=color:#080;font-weight:700>return</span> <span style=color:#00d;font-weight:700>0</span>;
}

<span style=color:#888>/*
</span><span style=color:#888> * Redirect stdin to UART0
</span><span style=color:#888> */</span>
<span style=color:#339;font-weight:700>int</span> <span style=color:#06b;font-weight:700>getchar</span>() {
    <span style=color:#080;font-weight:700>return</span> uart0_read();
}</code></pre></td></tr></table></div></div><p>Now we can use printf() for debugging.</p></div><div class=tags><div class=taxosfloating_left><p>Tags</p></div><div class=termsfloating_right><p><a href=/tags/8051/>8051</a>
<a href=/tags/bare-metal/>bare-metal</a>
<a href=/tags/ch559/>ch559</a>
<a href=/tags/mcs-51/>mcs-51</a>
<a href=/tags/uart/>uart</a></p></div><div class=clearit></div></div></div></div><div class="footer wrapper"><nav class=nav><div class=footertext>© 2020 Kali Prasad</div></nav></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-161815915-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>