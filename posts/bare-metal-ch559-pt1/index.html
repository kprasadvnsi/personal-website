<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>CH559 Programming (Part 1): Setup and blinky - Kali Prasad</title><meta name=Description content="CH559 Programming (Part 1): Setup and blinky - Kali Prasad"><link rel=icon type=image/png href=/favicon.ico><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="CH559 Programming (Part 1): Setup and blinky"><meta property="og:description" content="Bare Metal programming with CH559"><meta property="og:type" content="article"><meta property="og:url" content="https://kprasadvnsi.com/posts/bare-metal-ch559-pt1/"><meta property="og:image" content="https://kprasadvnsi.com/ch559_dev_board.jpg"><meta property="article:published_time" content="2020-03-24T00:00:00+00:00"><meta property="article:modified_time" content="2020-03-24T00:00:00+00:00"><meta property="og:site_name" content="Kali Prasad"><meta property="og:video" content="https://www.youtube.com/watch?v=s80IY7E03bQ"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://kprasadvnsi.com/ch559_dev_board.jpg"><meta name=twitter:title content="CH559 Programming (Part 1): Setup and blinky"><meta name=twitter:description content="Bare Metal programming with CH559"><meta name=twitter:site content="@kprasadvnsi"><meta name=twitter:creator content="@kprasadvnsi"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"CH559 Programming (Part 1): Setup and blinky","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/kprasadvnsi.com\/posts\/bare-metal-ch559-pt1\/"},"image":{"@type":"ImageObject","url":"https:\/\/kprasadvnsi.com\/ch559_dev_board.jpg","width":800,"height":570},"genre":"posts","keywords":"Bare Metal, CH559, 8051, SDCC, MCS-51","wordcount":681,"url":"https:\/\/kprasadvnsi.com\/posts\/bare-metal-ch559-pt1\/","datePublished":"2020-03-24T00:00:00","dateModified":"2020-03-24T00:00:00","license":"© 2020 Kali Prasad","publisher":{"@type":"Organization","name":"Kali Prasad","logo":{"@type":"ImageObject","url":"https:\/\/kprasadvnsi.com\/avatar.png","width":80,"height":80}},"author":{"@type":"Person","name":"Kali Prasad"},"description":"Bare Metal programming with CH559"}</script><link rel=preload href=https://kprasadvnsi.com/css/bundle.min.7ceb6505cb87d0614f44be28b935ac372beb44497009528d82e25ed4360ef407.css as=style onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel=stylesheet type=text/css media=screen href=https://kprasadvnsi.com/css/bundle.min.7ceb6505cb87d0614f44be28b935ac372beb44497009528d82e25ed4360ef407.css></noscript><script data-ad-client=ca-pub-6490269775913302 async src=https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js></script><script>(function(w){"use strict";if(!w.loadCSS){w.loadCSS=function(){};}
var rp=loadCSS.relpreload={};rp.support=(function(){var ret;try{ret=w.document.createElement("link").relList.supports("preload");}catch(e){ret=false;}
return function(){return ret;};})();rp.bindMediaToggle=function(link){var finalMedia=link.media||"all";function enableStylesheet(){if(link.addEventListener){link.removeEventListener("load",enableStylesheet);}else if(link.attachEvent){link.detachEvent("onload",enableStylesheet);}
link.setAttribute("onload",null);link.media=finalMedia;}
if(link.addEventListener){link.addEventListener("load",enableStylesheet);}else if(link.attachEvent){link.attachEvent("onload",enableStylesheet);}
setTimeout(function(){link.rel="stylesheet";link.media="only x";});setTimeout(enableStylesheet,3000);};rp.poly=function(){if(rp.support()){return;}
var links=w.document.getElementsByTagName("link");for(var i=0;i<links.length;i++){var link=links[i];if(link.rel==="preload"&&link.getAttribute("as")==="style"&&!link.getAttribute("data-loadcss")){link.setAttribute("data-loadcss",true);rp.bindMediaToggle(link);}}};if(!rp.support()){rp.poly();var run=w.setInterval(rp.poly,500);if(w.addEventListener){w.addEventListener("load",function(){rp.poly();w.clearInterval(run);});}else if(w.attachEvent){w.attachEvent("onload",function(){rp.poly();w.clearInterval(run);});}}
if(typeof exports!=="undefined"){exports.loadCSS=loadCSS;}
else{w.loadCSS=loadCSS;}}(typeof global!=="undefined"?global:this));</script></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=https://kprasadvnsi.com/><picture>
<source type=image/webp srcset=/avatar.webp><img src=/avatar.png alt="Kali Prasad"></picture></a></div><p class=site-title><a href=https://kprasadvnsi.com/>Kali Prasad</a></p><div class=site-description><p>Random blog</p><nav class="nav social"><ul class=flat><li class=li-social><a href=https://twitter.com/kprasadvnsi><i title=Twitter class="icons fab fa-twitter"></i></a></li><li class=li-social><a href=https://mastodon.social/@kprasadvnsi><i title=Mastodon class="icons fab fa-mastodon"></i></a></li><li class=li-social><a href=https://t.me/kprasadvnsi><i title=Telegram class="icons fab fa-telegram"></i></a></li><li class=li-social><a href=https://github.com/kprasadvnsi><i title=Github class="icons fab fa-github"></i></a></li><li class=li-social><a href=https://www.youtube.com/channel/UCJYk1lszl4uCf-kcCu27Ogw><i title=Youtube class="icons fab fa-youtube"></i></a></li><li class=li-social><a href=mailto:kprasadvnsi@protonmail.com><i title=Email class="icons fas fa-at"></i></a></li><li class=li-social><a href=/index.xml><i title=RSS class="icons fas fa-rss"></i></a></li></ul></nav></div><nav class=nav><ul class=flat><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/about>About</a></li><li><a href=/tags>Tags</a></li></ul></nav></div><div class=post><div class=author></div><div class=post-header><div class=meta><div class=date><span class=day>24</span>
<span class=rest>Mar 2020</span></div></div><div class=matter><h1 class=title>CH559 Programming (Part 1): Setup and blinky</h1></div></div><div class=markdown><p>The CH559 is a cheap 8051 based microcontroller with USB Host/Device capability and comes with plenty of Peripherals. CH559 is the most advance MCU in the CH55x series, the reason I am starting with the most advanced one because it is a Flash variant unlike other MCUs in the CH55x series.</p><p>In this tutorial, we will learn the bare minimum to get started without using any vendor-supplied libraries. I will start by getting to know the hardware and toolchain, later will write a simple LED blink example.</p><h2 id=hardware>Hardware</h2><p>There are several ways to start working with CH559. I find Electrodragon&rsquo;s <a href=https://www.electrodragon.com/product/ch559-mini-dev-board-ch55x-series/>CH559 USB MCU Mini DEV Board</a> easiest to get and cheap. It breakout all the pins and comes with 4 LEDs for demo.</p><p><img src=/ch559_dev_board.jpg alt="CH559 dev board"></p><h2 id=setting-up-the-toolchain>Setting up the toolchain</h2><p>Before we do anything, we need to find a compiler and a way to program this MCU. Unfortunately, a GCC compiler is not available for 8051 microcontrollers. Few commercial compilers available for these processors, some of them have a free version with a code size limit, but all of them are Windows only. Luckily, <strong>SDCC</strong> support 8051 based MCUs and its Open Source.</p><p>To program this MCU, we don&rsquo;t need any extra hardware as it comes with a USB Bootloader built-in. I found Rgwan&rsquo;s <strong>LibreCH551</strong> pretty straight forward to use. Now its time to download all the necessary tools:</p><ol><li><a href=https://sourceforge.net/projects/sdcc/files/sdcc-linux-amd64/4.0.0/sdcc-4.0.0-amd64-unknown-linux2.5.tar.bz2/download>SDCC</a></li><li><a href=https://github.com/rgwan/librech551>LibreCH551</a></li></ol><p>Extract SDCC under <code>~/local/sdcc</code> and add the following lines to your <code>.bashrc</code> file (Replace &ldquo;&lt;username>&rdquo; with your &ldquo;username&rdquo;).</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#007020>export</span> <span style=color:#963>PATH</span><span style=color:#333>=</span><span style=color:#963>$PATH</span>:/home/&lt;username&gt;/local/sdcc/bin</code></pre></div><p>If you have done the above steps correctly, you should be able to run <code>sdcc --version</code>.</p><p>For the <strong>LibreCH551</strong> have to make it from the source. Clone the Repo and go under <code>librech551/usbisp</code> and build the tool using <strong>make</strong> command. You will find the <strong>wchisptool</strong> executable in the same folder.</p><p><strong>Note.</strong> You may need to install the libusb-1.0-dev package if not already installed in your system.</p><p>Now copy <strong>wchisptool</strong> binary to <code>~/local/librech551/bin</code> and add the following lines to your <code>.bashrc</code> file (Replace &ldquo;&lt;username>&rdquo; with your &ldquo;username&rdquo;).</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#007020>export</span> <span style=color:#963>PATH</span><span style=color:#333>=</span><span style=color:#963>$PATH</span>:/home/&lt;username&gt;/local/librech551/bin</code></pre></div><p>We need to set up udev rules for USB bootloader so that we don&rsquo;t have to run <strong>wchisptool</strong> with root privilege. Create a file <code>/etc/udev/rules.d/99-ch559.rules</code> and add the following lines to the file.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback># CH559
ATTRS{idVendor}==&#34;4348&#34;, ATTRS{idProduct}==&#34;55e0&#34;, MODE=&#34;0666&#34;
</code></pre></div><p>Now run <code>udevadm control --reload-rules && udevadm trigger</code> as a root to restart <strong>udev</strong> service.</p><h2 id=everything-is-memory-mapped>Everything is memory-mapped</h2><p>You can access all Peripherals I/O and registers using memory addressing. SDCC conveniently provides two Macro <code>SFR()</code> and <code>SBIT()</code> to access the SFR(Special Function Register) and Bit addressable memory.</p><p>We need Datasheet for this MCU to know its pinout and register map. Unfortunately, WCH only provides Datasheet in Chinese. I have translated the Datasheet, you can find it <a href=https://kprasadvnsi.github.io/CH559_Doc_English/>here</a>.</p><p>Let&rsquo;s write our first example. Create a file <code>blink.c</code> and add the following code.</p><p><code>--------------------------- blink.c ---------------------------</code><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#579>#include</span> <span style=color:#579>&lt;compiler.h&gt;</span><span style=color:#579>
</span><span style=color:#579>#include</span> <span style=color:#579>&lt;stdint.h&gt;</span><span style=color:#579>
</span><span style=color:#579></span>
SFR(PORT_CFG,	<span style=color:#058;font-weight:700>0xC6</span>); <span style=color:#888>// Port Configuration Register
</span><span style=color:#888></span>SFR(P1_DIR,	<span style=color:#058;font-weight:700>0xBA</span>);	<span style=color:#888>// P1 port direction control register
</span><span style=color:#888></span>SFR(P1,	<span style=color:#058;font-weight:700>0x90</span>);	<span style=color:#888>// P1 port input and output register
</span><span style=color:#888></span>
SBIT(LED6, <span style=color:#058;font-weight:700>0x90</span>, <span style=color:#00d;font-weight:700>6</span>); <span style=color:#888>// accessing pin 1.6
</span><span style=color:#888></span>
<span style=color:#080;font-weight:700>static</span> <span style=color:#080;font-weight:700>inline</span> <span style=color:#339;font-weight:700>void</span> <span style=color:#06b;font-weight:700>delay</span>() {
    uint32_t i;
    <span style=color:#080;font-weight:700>for</span> (i <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>0</span>; i <span style=color:#333>&lt;</span> (<span style=color:#00d;font-weight:700>120000UL</span>); i<span style=color:#333>++</span>){}
        __asm__(<span style=background-color:#fff0f0>&#34;nop&#34;</span>);
}

<span style=color:#339;font-weight:700>void</span> <span style=color:#06b;font-weight:700>main</span>() {
	PORT_CFG <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>0</span>b00101101;
    P1_DIR <span style=color:#333>=</span> <span style=color:#00d;font-weight:700>0</span>b11110000;
	P1 <span style=color:#333>=</span> <span style=color:#058;font-weight:700>0x00</span>;

	<span style=color:#080;font-weight:700>while</span> (<span style=color:#00d;font-weight:700>1</span>) {
		delay();
		LED6 <span style=color:#333>=</span> <span style=color:#333>!</span>LED6;
	}
}</code></pre></td></tr></table></div></div></p><p>Save the <code>blink.c</code> file and compile it using the following command.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sdcc -V -mmcs51 --model-small --xram-size 0x1800 --xram-loc 0x0000 --code-size 0xF000 blink.c</code></pre></div><p>We need to convert the blinkihx file to blink.bin for wchisptool to program the CH559.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>objcopy -I ihex -O binary blink.ihx blink.bin</code></pre></div><p>Now its time to program the CH559 dev board with our blink example. Press the PROG button while plugging the USB cable to your PC then release the PROG button to put CH559 into Bootloader mode. Use the following command to program the MCU.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>wchisptool -f blink.bin -g</code></pre></div><p>Congratulations! We&rsquo;ve just written our first LED blink example.</p><div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden><iframe src=https://www.youtube.com/embed/s80IY7E03bQ style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 srcdoc="<style>*{padding:0;margin:0;overflow:hidden}html,body{height:100%}img,span{position:absolute;width:100%;top:0;bottom:0;margin:auto}span{height:1.5em;text-align:center;font:48px/1.5 sans-serif;color:white;text-shadow:0 0 0.5em black}</style><a href=https://www.youtube.com/embed/s80IY7E03bQ?autoplay=1><img src=https://img.youtube.com/vi/s80IY7E03bQ/hqdefault.jpg alt='Video The Dark Knight Rises: What Went Wrong? – Wisecrack Edition'><span>▶</span></a>" frameborder=0 allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen title="CH559 LED Blink demo"></iframe></div></div><div class=tags><div class=taxosfloating_left><p>Tags</p></div><div class=termsfloating_right><p><a href=/tags/8051/>8051</a>
<a href=/tags/bare-metal/>bare-metal</a>
<a href=/tags/ch559/>ch559</a>
<a href=/tags/mcs-51/>mcs-51</a>
<a href=/tags/sdcc/>sdcc</a></p></div><div class=clearit></div></div></div></div><div class="footer wrapper"><nav class=nav><div class=footertext>© 2020 Kali Prasad</div></nav></div><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-161815915-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>